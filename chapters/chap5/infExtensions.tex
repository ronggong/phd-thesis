%\update{Intro to this section} The inference extensions explored in the thesis aim to improve the inference algorithm, either by making it faster, or by improving the approximate inference methods. They utilize the time sparsity of onsets to make inference faster. 
\subsubsection{End-of-bar pattern sampling}
% \comment{clean up this section based on comments from Andre}
The use of bar (cycle) length rhythmic patterns for meter analysis in \bpmodel\ is well motivated. When there are multiple rhythmic patterns being tracked, we can theoretically infer the rhythmic pattern that occurred in the current bar only after observing the features corresponding to the whole bar. However, in the \acrshort{pfprior} algorithm with the \bpmodel, at the beginning of every bar, the pattern transition matrix $\tmPatt$ is used to sample a pattern for the current bar that is held fixed for the whole bar. This is contrary to intuition, in which we need the whole bar to see and infer which pattern occurred, a decision that can only be made at the end of the bar, not the beginning. The strategy of sampling a rhythmic pattern at the beginning of the bar and fixing it for the whole bar is not intuitive and hence is suboptimal. An extension to \acrshort{pfprior} algorithm is proposed to address this limitation. 

The extension, called end-of-bar pattern sampling extension to \gls{AMPF} (called \acrshort{pfacc} in short), defers the decision of sampling (and hence inferring) the pattern in the current bar to the end of the bar. In every bar being tracked, the algorithm accumulates weights for each of the patterns over the whole bar, and uses the final accumulated weight to choose the most likely pattern at the end of the bar. %The particle weights are updated at the end of the bar based on such an accumulated likelihood. 

The proposed enhancement can be formulated in a particle system using two different cluster groups. In addition to \gls{AMPF} clustering based on metrical position and tempo (ignoring rhythmic patterns), an additional grouping is achieved with the rhythmic patterns. % for each particle. %, each of which interacts within the group during resampling. 
Within a single system of particles, we can then defer the inference of patterns till the end of a bar, as outlined in detail next. We first start by rewriting the particle system of \eqnref{eqn:bpm:pfposterior} as, 
\begin{equation}\label{eqn:pfacc:pfposterior}
P(\hidVar_{1:\nframes} \mid \obsVar_{1:\nframes})\approx\overset{\nparticles}{\underset{i=1}{\sum}}\overset{\nrhythmPatts}{\underset{j=1}{\sum}}\weight_{\nframes}^{(i,j)}\delta(\hidVar_{1:K}-\hidVar_{1:\nframes}^{(i,j)})	
\end{equation}
where $\hidVar_{1:\nframes}^{(i,j)}$ are particle trajectories with weights $\weight_{\nframes}^{(i,j)}$, both indexed by $i$ and $j$. Compared to the particle system in \eqnref{eqn:bpm:pfposterior}, the additional index $j$ is used to index the rhythmic patterns. For each metrical position and tempo $\mpostempoVar = [\mpos,\tempoVar]$, there are $\nrhythmPatts$ different particles, one per rhythmic pattern. The weights can hence be organized in two dimensions (for the ease of understanding): one dimension denotes the subset of hidden variables $\mpostempoVar$, and the other dimension stores the weights of all the $\nrhythmPatts$ patterns for each $\mpostempoVar$. 
%
With a suitable proposal density, these weights can be computed recursively as, 
\begin{equation}\label{eqn:pfacc:wtproposal}
\weight_{k}^{(i,j)}\propto \weight_{k-1}^{(i,j)}\frac{P(\obsVar_{k} \mid \hidVar_{k}^{(i,j)})P(\hidVar_{k}^{(i,j)} \mid \hidVar_{k-1}^{(i,j)})}{Q(\hidVar_{k}^{(i,j)} \mid \hidVar_{k-1}^{(i,j)},\obsVar_{k})}
\end{equation}

As before, we choose to sample from the transition probability $Q(\hidVar_{k}^{(i,j)} | \hidVar_{k-1}^{(i,j)},\obsVar_{k}) = P(\hidVar_{k}^{(i,j)} | \hidVar_{k-1}^{(i,j)})$, which reduces weight update to,
%
\begin{equation}\label{eqn:pfacc:wtupdate}
\weight_{k}^{(i,j)}\propto \weight_{k-1}^{(i,j)}P(\obsVar_{k} \mid \hidVar_{k}^{(i,j)}) = w_{k-1}^{(i,j)}P(\obsVar_{k} \mid \mpostempoVar_{k}^{(i)},\rpattVar^{(i)}_k=j)
\end{equation}
Let us define the following terms: 
\begin{eqnarray}
 \weightVec_{k}^{(i,:)} &=& [\weight_{k}^{(i,1)}, \weight_{k}^{(i,2)}, \cdots, \weight_{k}^{(i,\nrhythmPatts)}] \\
 \weightSum_{k}^{(i)} &=& \overset{\nrhythmPatts}{\underset{j=1}{\sum}}\weight_{k}^{(i,j)}
\end{eqnarray}
%
Here, $\weightVec_{k}^{(i,:)}$ is a vector of weights of all rhythmic patterns for each $\mpostempoVar_{k}^{(i)}$, and $\weightSum_{k}^{(i)}$ denotes the weight of $\mpostempoVar_{k}^{(i)}$, computed as the marginal over all rhythmic patterns. 
\input{chapters/chap5/pfaccInf}

The \acrshort{pfacc} algorithm is outlined in \algoref{algo:pf:acc}. The algorithm can be interpreted to have two groups of particles in the particle system, one clustered based on $\mpostempoVar$ and the other is a group of $R$ particles (for each $\mpostempoVar$) representing rhythmic patterns. The weights $\weight^{(i,j)}$ accumulate the weight for every pattern $j$. For every $\mpostempoVar^{(i)}$ that crosses the end of a bar, the pattern $j^\optstar$ with maximum $\weight^{(i,j)}$ is assigned to the previous bar, thus deferring the decision of inference of rhythmic pattern to the end of the bar. Once the decision of previous bar is done, the weights in the vector $\weightVec^{(i,:)}$ of the current frame are redistributed based on the transition probabilities of the patterns from the inferred pattern $j^\optstar$ of the previous bar. As with systematic resampling in the \gls{AMPF} with \bpmodel, the resampling across $\mpostempoVar^{(.)}$ is done at a fixed interval of $\sampInterval$ using the marginal summed up weights $\weightSum^{(.)}$. Each of the two resampling/reweighting steps ensure that the new weights maintain a valid probability distribution over the particle system. 

It is necessary that all the $\nrhythmPatts$ rhythmic patterns associated with $\mpostempoVar^{(i)}$ to be of the same length, and hence the \acrshort{pfacc} algorithm can only be applied to the task of meter tracking. 
%Since all rhythmic patterns at a specific value of $\mpostempoVar$ are to be resampled together, it is necessary that all patterns be of equal size, and hence the \acrshort{pfacc} algorithm can only be used in the task of meter tracking.
\subsubsection{Faster Inference}
The \momodel\ presented in \secref{sec:mom:model} simplifies the \bpmodel\ and makes inference faster. Inference in \bpmodel\ can also be made faster by utilizing the time sparsity of onsets, using what we propose as \textit{hop inference}. The idea of hop inference is that instead of performing inference at every time frame, we do inference only at specific frames that are associated with rhythmic events such as onsets. 

Onset events are important cues to infer progression through metrical structures, and it is hypothesized that humans listen to these cues and use an inherent sense of time to track metrical structures accurately. We wish to analyze if automatic approaches can do a faster and accurate inference by just focusing on the onsets. Hop inference makes inference faster by skipping likelihood computation and sampling steps, and can speed up inference by a factor as large as 10. Two different hop inference algorithms extensions are proposed for \gls{AMPF} with \bpmodel\ in this work: 
\begin{description}[leftmargin=1em]
 \item[Peak Hop Inference (\pfpkhop)]: The peaks of the spectral flux feature sequence is an indicator of events such as onsets. Using a peak finding algorithm, the frames at which onset peaks occur are estimated. The progression of the particles by sampling from transition model and an update of their weights are done only at these peak frames, skipping the non-peak frames. The transition model update equations \eqnrefs{eqn:bpm:transx}{eqn:bpm:transpatt} are to be redefined accordingly. In particular, the position variable update shown in \eqnref{eqn:bpm:transmpos} scales the instantaneous tempo by the number of frames hopped from the previous peak in order to maintain the same tempo even with a peak hop inference. Peak hop inference can speed up inference by up to a factor of 10. 
 \item[Onset gated weight update (\pfobshop)]: Despite the advantage of a faster inference, peak hop inference can lead to sharp discontinuities in $\mpos$ and tempo values due to large jumps in their values since they are sampled with large gaps of a significant number of frames. An improvement to peak hop while maintaining continuity is the onset gated weight update, where $\tempoVar$ and $\mpos$ are sampled and updated every frame to maintain continuity, while weights of the particles (using the likelihoods from the observation model) are updated only at frames where there is a peak in the spectral flux feature, indicating a rhythmic event. The basic premise is to maintain the continuity in tracking the $\mpos$ and $\tempoVar$ variables, while retaining the principle of peak hop. Gated weight update needs an observation likelihood computation only at peak frames, and hence speeds up inference. The computational advantage however is lower than that for peak hop inference. 
\end{description}
%In \pfprior, at the beginning of every bar, for every particle, the transition model samples a pattern from the prior transition matrix $\tmPatt$ in \eqnref{eqn:bpm:transpatt}, and fixes it through the bar. This is contrary to intuition, in which we need the whole bar to see and infer which pattern occurred, a decision that can only be made at the end of the bar, not the beginning. Hence this extension is to defer the decision of the bar to the end of the cycle, accumulating likelihood over all the patterns until the end of bar. The particle weights are updated at the end of the bar based on such an accumulated likelihood. 